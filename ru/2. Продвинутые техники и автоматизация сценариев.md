# Gemini CLI: Продвинутые техники и автоматизация сценариев

Интерфейс командной строки (CLI) Gemini — мощный инструмент для работы с моделями Google AI прямо из терминала. В первой части мы рассмотрели базовые операции: установку, аутентификацию и выполнение одиночных команд. В этой статье мы поднимем уровень: научимся создавать многошаговые сценарии, которые можно сохранять, переиспользовать и делиться с командой. Gemini CLI перестаёт быть просто ассистентом и превращается в полноценный движок автоматизации.

**Предварительные требования:**

* Установленный и настроенный Google Cloud SDK.
* Аутентификация пройдена: `gcloud auth login`.
* Компоненты Alpha включены: `gcloud components install alpha`.

---

## 1. Мастерство ввода/вывода: конвейеры и файлы

CLI особенно эффективен при взаимодействии с другими инструментами через стандартные потоки ввода (stdin) и вывода (stdout).

### Передача вывода команд в Gemini

Используем pipe (`|`) для передачи вывода одной команды в Gemini. Это удобно для суммирования, объяснения или преобразования данных.

**Пример: суммирование изменений в Git**

```bash
git diff --staged | gemini --prompt text
```

* `git diff --staged` получает изменения, подготовленные к коммиту.
* `| gemini --prompt text` передаёт эти изменения в Gemini как текстовую подсказку.

### Чтение подсказок из файла

Для длинных подсказок удобно использовать файл вместо аргумента `--prompt`.

1. Создайте файл `refactor_prompt.txt`:

```
Refactor the following Python code to be more efficient and Pythonic. Add comments where the logic is complex. Here is the code:
```

2. Объедините подсказку и исходный код и передайте в Gemini:

```bash
cat refactor_prompt.txt script.py | gemini --prompt text > refactored_script.py
```

* `--prompt text` указывает CLI обрабатывать ввод как текст.
* `> refactored_script.py` сохраняет результат в новый файл.

---

## 2. Работа со структурированными данными: JSON

Для автоматизации важно получать машиночитаемый вывод. Запросите JSON, чтобы легко анализировать его инструментами вроде `jq`.

**Пример: извлечение сущностей из текста**

```bash
gemini --prompt text '
Extract the key entities from the following text and return them as a JSON object with "person", "location", and "organization" keys.

Text: "Yesterday, Dr. Anya Sharma from OmniCorp flew to Berlin to attend the annual tech summit."
' | jq .
```

Ожидаемый вывод:

```json
{
  "person": "Dr. Anya Sharma",
  "location": "Berlin",
  "organization": "OmniCorp"
}
```

---

## 3. Механизм выполнения сценариев

Ключевая идея: использовать `.md` файлы как "рецепты" для Gemini. В них описывается последовательность действий, которые должен выполнить CLI.

**Запуск сценария:**

```text
> Прочитай и выполни инструкции из файла 'имя_сценария.md'
```

Создайте директорию `scenarios` для хранения сценариев:

```bash
mkdir scenarios
```

---

## Сценарий 1: "Аудит Git-репозитория"

Этот сценарий автоматически проводит аудит проекта, исправляет ошибки и адаптируется под среду.

1. Создайте файл `scenarios/git-health-check.md`:

```markdown
Ты — опытный Git-инженер. Проведи полный аудит текущего репозитория.

Выполни шаги строго по порядку и дождись моего подтверждения:

1. **Проверка статуса:** Покажи текущий статус репозитория. Предложи команду `!git status`.  
2. **Запрос обновлений:** Получи последние изменения с удаленного сервера. Предложи команду `!git fetch origin`.  
3. **Сравнение веток:** Покажи разницу между локальной веткой `main` и `origin/main`. Предложи команду `!git log main..origin/main --oneline`.  
4. **Поиск больших файлов:** Найди 5 самых больших файлов в проекте, исключая `.git`. Предложи команду `!find . -type f -not -path "./.git/*" -printf "%s %p\n" | sort -rn | head -n 5`.  
5. **Итог:** Кратко опиши состояние репозитория.
```

2. Запустите сценарий:

```text
> Прочитай и выполни сценарий 'scenarios/git-health-check.md'
```

**Особенности исполнения:**

* Если репозиторий не инициализирован, Gemini предложит создать его (`git init`) и добавить файлы.
* Команды, которые не работают в Windows (`find` и `head`), будут автоматически адаптированы под PowerShell.
* Ошибки, связанные с отсутствием ветки `main` или удалённого репозитория, предвидятся и обрабатываются.

**Итог:** репозиторий инициализирован, добавлены файлы, выявлены крупные файлы, сформированы рекомендации по `.gitignore`.

---

## Сценарий 2: "Очистка Docker-окружения"

Сценарий безопасно очищает Docker от ненужных образов, контейнеров и сетей.

1. Создайте файл `scenarios/docker-cleanup.md`:

```markdown
Ты — DevOps-инженер. Очисти Docker безопасно:

1. **Покажи запущенные контейнеры:** Предложи `!docker ps`.  
2. **Останови все контейнеры:** После подтверждения предложи `!docker stop $(docker ps -q)`.  
3. **Глобальная очистка:** Очисти систему от остановленных контейнеров, неиспользуемых сетей и dangling-образов. Предложи `!docker system prune -af`.  
4. **Отчет:** Сообщи, сколько места было освобождено.
```

2. Запустите сценарий:

```text
> Прочитай и выполни сценарий 'scenarios/docker-cleanup.md'
```

Gemini проведет вас через безопасный процесс очистки, запрашивая подтверждения на критических этапах.

---

## Сценарий 3: "Запуск системных приложений Windows"

Gemini может управлять запуском приложений. Создадим сценарий:

1. Создайте файл `scenarios/open-windows-tools.md`:

```markdown
Ты — системный администратор Windows. Открывай системные утилиты по запросу:

- "Планировщик задач" → `!taskschd.msc`  
- "Редактор реестра" → `!regedit`  
- "Монитор ресурсов" → `!resmon`  
- "Диспетчер задач" → `!taskmgr`  
- "Командная строка" → `!cmd`  
- "Проводник" → `!explorer`
```

2. Запустите сценарий и дайте команду:

```text
> Используй инструкции из 'scenarios/open-windows-tools.md'. Открой планировщик задач.
```

Gemini поймёт контекст и предложит выполнить соответствующую команду.

---

## Рекомендации и ограничения

* **Безопасность:** не передавайте ключи API, пароли или личные данные в подсказки.
* **Детерминизм:** результаты LLM не всегда предсказуемы. Для критически важных задач включайте проверку ошибок.
* **Токены и стоимость:** учитывайте ограничения на токены и возможные расходы.
* **Экспериментируйте:** пробуйте новые сценарии для поиска эффективных автоматизаций.

