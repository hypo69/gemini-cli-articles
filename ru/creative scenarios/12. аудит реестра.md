

### Скрипт аудита реестра

Этот скрипт выполняет четыре ключевые проверки:

1.  **Автозагрузка:** Ищет программы, которые запускаются вместе с системой, в наиболее популярных ключах реестра.
2.  **Настройки безопасности:** Проверяет статус UAC (User Account Control).
3.  **Информация о системе:** Выводит версию Windows и другую важную информацию.
4.  **История USB-устройств:** Показывает информацию о всех USB-устройствах, которые когда-либо подключались.

**Важно:** Для выполнения этого скрипта могут потребоваться права администратора.

**Команда, которую можно использовать в Gemini CLI:**

```powershell
gemini-cli "Напиши скрипт PowerShell для комплексного аудита реестра. Скрипт должен проверять автозагрузку для HKLM и HKCU, статус UAC, версию Windows и историю подключенных USB-устройств. Вывод должен быть структурирован и легко читаем."
```

**Пример сгенерированного скрипта:**

```powershell
Write-Host "--- Комплексный аудит реестра Windows ---" -ForegroundColor Green
Write-Host "Скрипт проверяет ключевые области реестра для получения информации о системе и безопасности." -ForegroundColor Cyan

# 1. Проверка программ в автозагрузке
Write-Host "`n[1] Проверка программ в автозагрузке" -ForegroundColor Yellow
$autoRunPaths = @(
    "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run",
    "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run",
    "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run"
)

foreach ($path in $autoRunPaths) {
    if (Test-Path -Path $path) {
        Write-Host "  - Проверка ключа: $path" -ForegroundColor Cyan
        Get-ItemProperty -Path $path -ErrorAction SilentlyContinue | ForEach-Object {
            $name = $_.PSChildName
            $value = $_.$name
            if ($value) {
                Write-Host "    - Название: $name" -ForegroundColor Magenta
                Write-Host "      Путь:   $value" -ForegroundColor Magenta
            }
        }
    }
}


# 2. Проверка настроек безопасности (UAC)
Write-Host "`n[2] Проверка настроек безопасности" -ForegroundColor Yellow
$uacStatus = (Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System").EnableLUA
if ($uacStatus -eq 1) {
    Write-Host "  - UAC (User Account Control): ВКЛЮЧЁН" -ForegroundColor Green
} else {
    Write-Host "  - UAC (User Account Control): ОТКЛЮЧЁН" -ForegroundColor Red
}


# 3. Получение информации о версии Windows
Write-Host "`n[3] Информация о системе" -ForegroundColor Yellow
$osInfo = Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion"
Write-Host "  - Версия ОС: $($osInfo.ProductName) $($osInfo.CurrentVersion)" -ForegroundColor Cyan
Write-Host "  - Сборка ОС: $($osInfo.BuildLabEx)" -ForegroundColor Cyan


# 4. Аудит истории подключений USB-устройств
Write-Host "`n[4] История подключений USB-устройств" -ForegroundColor Yellow
Write-Host "  (Требует прав администратора)" -ForegroundColor Red
try {
    $usbDevices = Get-ItemProperty "HKLM:\SYSTEM\CurrentControlSet\Enum\USBSTOR\*"
    if ($usbDevices.Count -gt 0) {
        $usbDevices | ForEach-Object {
            Write-Host "  - Устройство: $($_.PSChildName)" -ForegroundColor Magenta
            Write-Host "    Описание: $($_.FriendlyName)" -ForegroundColor Magenta
        }
    } else {
        Write-Host "  - USB-устройства не найдены в реестре." -ForegroundColor Green
    }
} catch {
    Write-Host "  - Ошибка: Не удалось получить доступ к ключу USB-устройств. Запустите скрипт с правами администратора." -ForegroundColor Red
}


Write-Host "`n--- Аудит завершён ---" -ForegroundColor Green
```

### Как это работает?

  * **`Test-Path`**: Перед тем как читать данные, скрипт проверяет, существует ли ключ реестра. Это помогает избежать ошибок.
  * **`Get-ItemProperty`**: Основной командлет для чтения значений из ключей реестра.
  * **Перебор путей**: Скрипт использует массив `$autoRunPaths`, чтобы пройти по всем основным местам автозагрузки, включая 32-битные программы на 64-битной системе (`WOW6432Node`).
  * **Обработка ошибок**: Блок `try...catch` используется для корректной обработки ситуаций, когда у пользователя нет прав доступа к определённым ключам реестра, например, к истории USB-устройств.
  * **Форматированный вывод**: С помощью `Write-Host` и разных цветов скрипт делает отчёт более наглядным и легко читаемым.

Этот скрипт — отличная отправная точка для более глубокого аудита. Вы можете добавлять в него новые проверки или сохранять результаты в файл для последующего анализа.